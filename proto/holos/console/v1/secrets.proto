syntax = "proto3";

package holos.console.v1;

import "holos/console/v1/rbac.proto";

option go_package = "github.com/holos-run/holos-console/gen/holos/console/v1;consolev1";

// SecretsService provides access to Kubernetes secrets with RBAC.
service SecretsService {
  // ListSecrets returns all secrets in the current namespace with console label.
  // Only returns secrets with the app.kubernetes.io/managed-by=console.holos.run label.
  // Each secret includes sharing grants for the UI.
  // Requires authentication via Authorization: Bearer <id_token> header.
  rpc ListSecrets(ListSecretsRequest) returns (ListSecretsResponse);

  // GetSecret retrieves a secret by name from the current namespace.
  // Requires authentication via Authorization: Bearer <id_token> header.
  // Returns PermissionDenied if user does not have an active sharing grant.
  rpc GetSecret(GetSecretRequest) returns (GetSecretResponse);

  // UpdateSecret replaces the data of an existing secret.
  // Requires authentication and PERMISSION_SECRETS_WRITE.
  // Only operates on secrets with the console managed-by label.
  rpc UpdateSecret(UpdateSecretRequest) returns (UpdateSecretResponse);

  // CreateSecret creates a new secret with the console managed-by label.
  // Requires authentication and PERMISSION_SECRETS_WRITE.
  rpc CreateSecret(CreateSecretRequest) returns (CreateSecretResponse);

  // DeleteSecret deletes a secret by name.
  // Requires authentication and PERMISSION_SECRETS_DELETE.
  // Only operates on secrets with the console managed-by label.
  rpc DeleteSecret(DeleteSecretRequest) returns (DeleteSecretResponse);

  // UpdateSharing updates the sharing grants on a secret without touching its data.
  // Requires ROLE_OWNER on the secret.
  rpc UpdateSharing(UpdateSharingRequest) returns (UpdateSharingResponse);

  // GetSecretRaw retrieves the full Kubernetes Secret object as verbatim JSON.
  // The backend returns the Secret exactly as the K8s API provides it, with no
  // field filtering. Requires authentication and PERMISSION_SECRETS_READ.
  rpc GetSecretRaw(GetSecretRawRequest) returns (GetSecretRawResponse);
}

// GetSecretRequest contains the name of the secret to retrieve.
message GetSecretRequest {
  // name is the name of the secret to retrieve.
  string name = 1;
  // project is the project (namespace) containing the secret.
  string project = 2;
}

// GetSecretResponse contains the secret data.
message GetSecretResponse {
  // data contains the secret key-value pairs.
  // Values are the raw secret bytes (not base64 encoded).
  map<string, bytes> data = 1;
}

// ListSecretsRequest contains optional filters for listing secrets.
message ListSecretsRequest {
  // project is the project (namespace) to list secrets from.
  string project = 1;
}

// ListSecretsResponse contains the list of secrets in the namespace.
message ListSecretsResponse {
  // secrets contains metadata about each secret.
  repeated SecretMetadata secrets = 1;
}

// UpdateSecretRequest contains the name and replacement data for a secret.
message UpdateSecretRequest {
  // name is the name of the secret to update.
  string name = 1;
  // data replaces the entire secret data map.
  // Values are the raw secret bytes (not base64 encoded).
  map<string, bytes> data = 2;
  // string_data contains plaintext string values that are merged into data.
  // Values are encoded to bytes before storage, matching Kubernetes stringData
  // semantics. When both data and string_data contain the same key, string_data
  // takes precedence.
  map<string, string> string_data = 3;
  // description is a human-readable description of the secret's purpose.
  // When set, updates the description annotation. When unset, preserves the existing value.
  optional string description = 4;
  // url is a URL associated with the secret.
  // When set, updates the URL annotation. When unset, preserves the existing value.
  optional string url = 5;
  // project is the project (namespace) containing the secret.
  string project = 6;
}

// UpdateSecretResponse is empty on success.
message UpdateSecretResponse {}

// CreateSecretRequest contains the new secret's name, data, and sharing grants.
message CreateSecretRequest {
  // name is the name of the secret to create.
  string name = 1;
  // data contains the secret key-value pairs.
  // Values are the raw secret bytes (not base64 encoded).
  map<string, bytes> data = 2;
  // string_data contains plaintext string values that are merged into data.
  // Values are encoded to bytes before storage, matching Kubernetes stringData
  // semantics. When both data and string_data contain the same key, string_data
  // takes precedence.
  map<string, string> string_data = 3;
  // user_grants are the per-user sharing grants to set on the created secret.
  repeated ShareGrant user_grants = 4;
  // role_grants are the per-role sharing grants to set on the created secret.
  repeated ShareGrant role_grants = 5;
  // description is a human-readable description of the secret's purpose.
  optional string description = 6;
  // url is a URL associated with the secret (e.g. link to the service that uses it).
  optional string url = 7;
  // project is the project (namespace) containing the secret.
  string project = 8;
}

// CreateSecretResponse contains the name of the created secret.
message CreateSecretResponse {
  // name is the name of the created secret.
  string name = 1;
}

// DeleteSecretRequest contains the name of the secret to delete.
message DeleteSecretRequest {
  // name is the name of the secret to delete.
  string name = 1;
  // project is the project (namespace) containing the secret.
  string project = 2;
}

// DeleteSecretResponse is empty on success.
message DeleteSecretResponse {}

// SecretMetadata contains non-sensitive information about a secret.
message SecretMetadata {
  // name is the name of the secret.
  string name = 1;
  // accessible indicates whether the current user has permission to read this secret.
  bool accessible = 2;
  // user_grants contains per-user sharing grants on this secret.
  repeated ShareGrant user_grants = 5;
  // role_grants contains per-role sharing grants on this secret.
  repeated ShareGrant role_grants = 6;
  // description is a human-readable description of the secret's purpose.
  optional string description = 7;
  // url is a URL associated with the secret (e.g. link to the service that uses it).
  optional string url = 8;
}

// ShareGrant represents a sharing grant for a principal (user email or role name).
message ShareGrant {
  // principal is the email address (for users) or role name (for roles).
  string principal = 1;
  // role is the permission level granted to the principal.
  Role role = 2;
  // nbf (not before) is the unix timestamp before which the grant is inactive.
  // When unset, the grant has no start time restriction.
  optional int64 nbf = 3;
  // exp (expiration) is the unix timestamp at or after which the grant is inactive.
  // When unset, the grant has no expiration.
  optional int64 exp = 4;
}

// UpdateSharingRequest contains the sharing grants to set on a secret.
message UpdateSharingRequest {
  // name is the name of the secret to update sharing for.
  string name = 1;
  // user_grants are the per-user sharing grants to set.
  repeated ShareGrant user_grants = 2;
  // role_grants are the per-role sharing grants to set.
  repeated ShareGrant role_grants = 3;
  // project is the project (namespace) containing the secret.
  string project = 4;
}

// UpdateSharingResponse contains the updated secret metadata.
message UpdateSharingResponse {
  // metadata contains the updated secret metadata including new sharing grants.
  SecretMetadata metadata = 1;
}

// GetSecretRawRequest contains the name of the secret to retrieve as raw JSON.
message GetSecretRawRequest {
  // name is the name of the secret to retrieve.
  string name = 1;
  // project is the project (namespace) containing the secret.
  string project = 2;
}

// GetSecretRawResponse contains the full Kubernetes Secret object as JSON.
message GetSecretRawResponse {
  // raw is the verbatim JSON-serialized Secret object from the K8s API.
  string raw = 1;
}
